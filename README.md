  flowchart TD
  %% ====== START ======
  S([เริ่ม: ค้นหาเชิงรุก/Walk-in/อสม./รพ.สต.]) --> R1[ลงทะเบียนเข้าระบบกลาง\n(ชื่อ-อายุ-เบอร์-ที่อยู่-รพ.สต.)]

  %% ====== LAYER 1: Questionnaire ======
  R1 --> Q1[คัดกรองชั้นที่ 1: แบบสอบถาม]
  Q1 -->|คะแนนต่ำ/ไม่เสี่ยง| G0[ให้ความรู้ + นัดคัดกรองซ้ำตามรอบ] --> E0([จบ])

  Q1 -->|คะแนนถึงเกณฑ์เสี่ยง| L2[คัดกรองชั้นที่ 2 ที่รพ.สต./จุดชุมชน]

  %% ====== LAYER 2: Quick test + Otoscopy ======
  subgraph COMMUNITY[ชุมชน/รพ.สต.]
    L2 --> OTO[Otoscopy/ภาพหู (ถ้ามี)\nAI ช่วยคัดคุณภาพภาพ + พบขี้หู/อักเสบ?]
    OTO -->|พบขี้หูอุดตัน/หูอักเสบเด่น| TX[รักษา/ล้างขี้หู/หยอดยา\nแล้วนัดทดสอบซ้ำ] --> RETEST[ทดสอบซ้ำชั้นที่ 2]
    OTO -->|ไม่พบ/จัดการแล้ว| DIN[ทดสอบได้ยินเร็ว 3–5 นาที\nDIN/มือถือ หรือ Screening tone]
    RETEST --> DIN
    DIN --> TRIAGE[คำนวณ Triage 3 สี\nRule/AI (อายุ+คะแนน+ผลทดสอบ)]
  end

  %% ====== TRIAGE ======
  TRIAGE -->|สีเขียว: ต่ำ| GREEN[ให้ความรู้/ป้องกันเสียงดัง\nนัดคัดกรองซ้ำ] --> E1([จบ])
  TRIAGE -->|สีเหลือง: borderline/ข้างเดียว/เล็กน้อย| YELLOW[เส้นทางเหลือง:\n1) จัดการขี้หู/โรคหู\n2) นัดทดสอบซ้ำ 1–3 เดือน\n3) Tele-ENT/คลินิกหูตึงทั่วไป]
  TRIAGE -->|สีแดง: fast-track พิการ| RED[เส้นทางแดง:\nจองคิว Audiometry (Hub) + เตือนนัด\nเตรียมเอกสารล่วงหน้า]

  %% ====== HUB: Confirmatory Audiometry ======
  subgraph HUB[Hub: รพ.ศรีสังวรสุโขทัย / จุดตรวจยืนยัน]
    RED --> APPT[จัดตารางคิว:\nให้ RED ก่อน, กันคิว/ลด no-show]
    YELLOW -->|ถ้าอาการมากขึ้น/ทดสอบซ้ำยัง fail| APPT
    APPT --> PTA[ตรวจ Audiometry (PTA)]
    PTA --> RESULT{ผลเข้าเกณฑ์พิการ?\n(เช่น ≥40 dB ตามเกณฑ์ที่ใช้)}
    RESULT -->|ไม่เข้าเกณฑ์| NONDIS[สรุปผล + แผนฟื้นฟูทั่วไป\n(ติดตาม/ป้องกัน/รักษาโรคหู)] --> E2([จบ])
    RESULT -->|เข้าเกณฑ์| CERT[แพทย์ออกใบรับรองความพิการ]
  end

  %% ====== DOCUMENTS & REGISTRATION ======
  subgraph ADMIN[อปท./พมจ./One-Stop]
    CERT --> DOC[ส่งชุดเอกสาร/ข้อมูลให้ อปท./พมจ.\n(One-Stop day หรือส่งดิจิทัล)]
    DOC --> CARD[ขึ้นทะเบียนและออกบัตรผู้พิการ]
  end

  %% ====== REHAB ======
  CARD --> HA[กลับมารพ.: ประเมิน-เลือก-ใส่เครื่องช่วยฟัง\n+ ให้คำแนะนำ/rehab]
  HA --> FU[ติดตามผล 1–3 เดือน:\nการได้ยิน/การใช้เครื่อง/ปัญหา]
  FU --> E3([จบเส้นทางฟื้นฟู])

  %% ====== DATA LOOP ======
  FU --> DATA[บันทึกข้อมูลทุกขั้น:\nคะแนน/ผล DIN/ผล PTA/เข้าเกณฑ์จริง/no-show]
  DATA --> KPI[Dashboard KPI รายสัปดาห์/รายเดือน:\nPPV, จำนวนออกใบ, รอคิว, no-show]
  KPI --> IMP[ปรับ cut-off/กติกา triage/กำลังตรวจ/หน่วยเคลื่อนที่]
  IMP --> Q1
